import { create } from "zustand";

import formatDateToString from "@/utils/formatDate";
import formatMoneyToString from "@/utils/formatMoney";

const MOCK_HISTORY_DATA_BEFORE = {
  id: "bitcoin",
  symbol: "btc",
  name: "Bitcoin",
  localization: {
    en: "Bitcoin",
    de: "Bitcoin",
    es: "Bitcoin",
    fr: "Bitcoin",
    it: "Bitcoin",
    pl: "Bitcoin",
    ro: "Bitcoin",
    hu: "Bitcoin",
    nl: "Bitcoin",
    pt: "Bitcoin",
    sv: "Bitcoin",
    vi: "Bitcoin",
    tr: "Bitcoin",
    ru: "Биткоин",
    ja: "ビットコイン",
    zh: "比特币",
    "zh-tw": "比特幣",
    ko: "비트코인",
    ar: "بيتكوين",
    th: "บิตคอยน์",
    id: "Bitcoin",
    cs: "Bitcoin",
    da: "Bitcoin",
    el: "Bitcoin",
    hi: "Bitcoin",
    no: "Bitcoin",
    sk: "Bitcoin",
    uk: "Bitcoin",
    he: "Bitcoin",
    fi: "Bitcoin",
    bg: "Bitcoin",
    hr: "Bitcoin",
    lt: "Bitcoin",
    sl: "Bitcoin",
  },
  image: {
    thumb:
      "https://assets.coingecko.com/coins/images/1/thumb/bitcoin.png?1547033579",
    small:
      "https://assets.coingecko.com/coins/images/1/small/bitcoin.png?1547033579",
  },
  market_data: {
    current_price: {
      aed: 31013.62311335185,
      ars: 205770.6954532047,
      aud: 11220.4765088236,
      bch: 6.560412900969795,
      bdt: 716090.5985295622,
      bhd: 3188.039976693728,
      bmd: 8443.26024591542,
      brl: 31577.0587560823,
      btc: 1,
      cad: 10872.89281428,
      chf: 8425.8418000281,
      clp: 5378919.663478938,
      cny: 53905.1507140224,
      czk: 183941.49041341498,
      dkk: 53432.5645515381,
      eth: 11.9963485679568,
      eur: 7175.28519522483,
      gbp: 6264.47693945695,
      hkd: 66277.9887109893,
      huf: 2275806.9207593496,
      idr: 119509789.4204,
      ils: 30172.58151699597,
      inr: 574015.04781856,
      jpy: 936180.252806856,
      krw: 9132990.17540426,
      kwd: 2549.2397930082593,
      lkr: 1332991.244817393,
      ltc: 61.44402785780512,
      mmk: 11432166.664272875,
      mxn: 167970.219332241,
      myr: 33540.952646022,
      ngn: 3042236.1862154985,
      nok: 67970.27136207816,
      nzd: 12211.0989036962,
      php: 441708.64472619,
      pkr: 976463.0474401184,
      pln: 30863.7045844254,
      rub: 526744.611005778,
      sar: 31661.803759170532,
      sek: 73961.2711021699,
      sgd: 11339.9486413034,
      thb: 271450.81690618076,
      try: 38671.31398272706,
      twd: 252799.655022954,
      uah: 220517.38984135175,
      usd: 8443.26024591542,
      vef: 590289431.9425619,
      vnd: 192275173.68168524,
      xag: 513.066107244383,
      xau: 6.53609662156805,
      xdr: 5918.95340041335,
      zar: 107824.638083942,
      bits: 1000000,
      link: 18719.807650428647,
      sats: 100000000,
    },
    market_cap: {
      aed: 528631454833.4487,
      ars: 3507389694585.151,
      aud: 191254559298.17996,
      bch: 111823136.67359759,
      bdt: 12205862356348.385,
      bhd: 54340578164.22139,
      bmd: 143916527618.282,
      brl: 538235292554.4724,
      btc: 17045137,
      cad: 185329947605.71817,
      chf: 143619627821.80557,
      clp: 91684422575992.38,
      cny: 918820678926.1597,
      czk: 3135307904080.844,
      dkk: 910765383042.3104,
      eth: 204479404.84057745,
      eur: 122303719166.67897,
      gbp: 106778867666.38441,
      hkd: 1129717397663.266,
      huf: 38791440749891.26,
      idr: 2037060733511868.5,
      ils: 514295785600.8641,
      inr: 9784165130128.906,
      jpy: 15957320665787.494,
      krw: 155673068759419.66,
      kwd: 43452141517.67742,
      lkr: 22721018387712.996,
      ltc: 1047321872.6681048,
      mmk: 194862846999364.1,
      mxn: 2863075400438.096,
      myr: 571710132961.9575,
      ngn: 51855332580400.67,
      nok: 1158562587293.7986,
      nzd: 208139853734.05154,
      php: 7528984363442.236,
      pkr: 16643946419054.316,
      pln: 526076072969.059,
      rub: 8978434058605.193,
      sar: 539679782742.17664,
      sek: 1260679998630.627,
      sgd: 193290978163.98032,
      thb: 4626916362927.767,
      try: 659157844805.5981,
      twd: 4309004753418.9893,
      uah: 3758749120728.248,
      usd: 143916527618.282,
      vef: 10061564237113142,
      vnd: 3277356677103119,
      xag: 8745282088.0372,
      xau: 111408662.35986456,
      xdr: 100889371606.6614,
      zar: 1837885728116.209,
      bits: 17045137000000,
      link: 319081686015.2044,
      sats: 1704513700000000,
    },
    total_volume: {
      aed: 6100671284.371249,
      ars: 40477030636.77279,
      aud: 2207173234.296268,
      bch: 1290494.9045226069,
      bdt: 140861754058.54968,
      bhd: 627117440.2345089,
      bmd: 1660868681.4973857,
      brl: 6211504373.2249365,
      btc: 196709.40289929602,
      cad: 2138800253.2850652,
      chf: 1657442309.407457,
      clp: 1058084075246.2242,
      cny: 10603650010.151907,
      czk: 36183020747.62945,
      dkk: 10510687868.311152,
      eth: 2359794.563774607,
      eur: 1411446066.384835,
      gbp: 1232281518.2369862,
      hkd: 13037503584.704988,
      huf: 447672620496.6572,
      idr: 23508699317507.49,
      ils: 5935230494.138613,
      inr: 112914157311.5998,
      jpy: 184155458535.74866,
      krw: 1796545044088.909,
      kwd: 501459437.52977973,
      lkr: 262211911838.01868,
      ltc: 12086618.031636555,
      mmk: 2248814678374.354,
      mxn: 33041321549.70892,
      myr: 6597820767.672551,
      ngn: 598436463669.0823,
      nok: 13370391494.537516,
      nzd: 2402037974.0903277,
      php: 86888243759.54613,
      pkr: 192079463015.17267,
      pln: 6071180900.062586,
      rub: 103615617911.36855,
      sar: 6228174512.181122,
      sek: 14548877476.1808,
      sgd: 2230674526.1394753,
      thb: 53396928110.140945,
      try: 7607011082.873437,
      twd: 49728069192.7133,
      uah: 43377844084.60359,
      usd: 1660868681.4973857,
      vef: 116115481695185.98,
      vnd: 37822334607282.74,
      xag: 100924927.60390876,
      xau: 1285711.6637207572,
      xdr: 1164313789.184068,
      zar: 21210120175.324924,
      bits: 196709402899.29602,
      link: 3682362185.305493,
      sats: 19670940289929.6,
    },
  },
  community_data: {
    facebook_likes: null,
    twitter_followers: 54210,
    reddit_average_posts_48h: 2.25,
    reddit_average_comments_48h: 180.208,
    reddit_subscribers: 835428,
    reddit_accounts_active_48h: "8727.44897959184",
  },
  developer_data: {
    forks: 19038,
    stars: 31654,
    subscribers: 3285,
    total_issues: 3935,
    closed_issues: 3405,
    pull_requests_merged: 5456,
    pull_request_contributors: 502,
    code_additions_deletions_4_weeks: {
      additions: null,
      deletions: null,
    },
    commit_count_4_weeks: 272,
  },
  public_interest_stats: {
    alexa_rank: null,
    bing_matches: null,
  },
};
const MOCK_HISTORY_DATA_AFTER = {
  id: "bitcoin",
  symbol: "btc",
  name: "Bitcoin",
  localization: {
    en: "Bitcoin",
    de: "Bitcoin",
    es: "Bitcoin",
    fr: "Bitcoin",
    it: "Bitcoin",
    pl: "Bitcoin",
    ro: "Bitcoin",
    hu: "Bitcoin",
    nl: "Bitcoin",
    pt: "Bitcoin",
    sv: "Bitcoin",
    vi: "Bitcoin",
    tr: "Bitcoin",
    ru: "Биткоин",
    ja: "ビットコイン",
    zh: "比特币",
    "zh-tw": "比特幣",
    ko: "비트코인",
    ar: "بيتكوين",
    th: "บิตคอยน์",
    id: "Bitcoin",
    cs: "Bitcoin",
    da: "Bitcoin",
    el: "Bitcoin",
    hi: "Bitcoin",
    no: "Bitcoin",
    sk: "Bitcoin",
    uk: "Bitcoin",
    he: "Bitcoin",
    fi: "Bitcoin",
    bg: "Bitcoin",
    hr: "Bitcoin",
    lt: "Bitcoin",
    sl: "Bitcoin",
  },
  image: {
    thumb:
      "https://assets.coingecko.com/coins/images/1/thumb/bitcoin.png?1547033579",
    small:
      "https://assets.coingecko.com/coins/images/1/small/bitcoin.png?1547033579",
  },
  market_data: {
    current_price: {
      aed: 99492.32952440798,
      ars: 6272292.322836259,
      aud: 40762.01264879851,
      bch: 232.66290636755187,
      bdt: 2899749.9485688163,
      bhd: 10195.691623195531,
      bmd: 27093.79110149735,
      bnb: 87.23160963851173,
      brl: 135468.95550748624,
      btc: 1,
      cad: 36567.1351601359,
      chf: 24378.2075131854,
      clp: 21637101.573655747,
      cny: 189862.45052285248,
      czk: 595925.2258983239,
      dkk: 186735.82702973994,
      dot: 5010.0749491963925,
      eos: 30875.9377089178,
      eth: 14.894754176854226,
      eur: 25046.25912037498,
      gbp: 21768.20842879587,
      hkd: 211771.84469707904,
      huf: 9416853.504191924,
      idr: 404672863.8919645,
      ils: 98911.3031742363,
      inr: 2244444.2360898177,
      jpy: 3737994.959761932,
      krw: 35904827.43665975,
      kwd: 8306.739601390267,
      lkr: 8295983.8811050095,
      ltc: 293.5372060124504,
      mmk: 56743343.012697995,
      mxn: 482176.00802735245,
      myr: 122965.17091414542,
      ngn: 12523696.145546975,
      nok: 296783.3556914688,
      nzd: 43098.391536853895,
      php: 1507742.5435699746,
      pkr: 7721306.500283589,
      pln: 113742.85083006253,
      rub: 2170107.7600707924,
      sar: 101602.93585121499,
      sek: 287661.01169655076,
      sgd: 36424.89275685301,
      thb: 929625.7143433781,
      try: 536728.0017206618,
      twd: 830018.2633005799,
      uah: 998008.2484864778,
      usd: 27093.79110149735,
      vef: 2712.9013029929283,
      vnd: 636162215.0631578,
      xag: 1136.1987211225307,
      xau: 13.69862078091705,
      xdr: 20090.99438444884,
      xlm: 304346.3083810451,
      xrp: 57691.836071982136,
      yfi: 4.051176446751466,
      zar: 527017.5869898854,
      bits: 999982.9529625297,
      link: 4164.410314762328,
      sats: 99998295.29625298,
    },
    market_cap: {
      aed: 1928023023080.2505,
      ars: 121548304916823.5,
      aud: 789911134151.2198,
      bch: 4507580061.499577,
      bdt: 56193122512473.63,
      bhd: 197578328698.44592,
      bmd: 525040003344.1629,
      bnb: 1690846559.6848755,
      brl: 2625200016720.8145,
      btc: 19379118,
      cad: 708620240513.4497,
      chf: 472415768848.981,
      clp: 419296946670648,
      cny: 3679270327434.5547,
      czk: 11548202369554.531,
      dkk: 3618680711048.636,
      dot: 97068060853.44905,
      eos: 596997071895.5654,
      eth: 288642410.9717842,
      eur: 485361680211.4366,
      gbp: 421837615246.82996,
      hkd: 4103843926138.8022,
      huf: 182485528762313.9,
      idr: 7841997489948411,
      ils: 1916763540208.5344,
      inr: 43494208869029.805,
      jpy: 72437145426481.44,
      krw: 695785637631701.4,
      kwd: 160973064705.2934,
      lkr: 160764633799725.8,
      ltc: 5688287698.928628,
      mmk: 1099607097933940.4,
      mxn: 9343900671514.56,
      myr: 2382894055177.482,
      ngn: 242691819742269.1,
      nok: 5751248818631.708,
      nzd: 835186908759.5953,
      php: 29217954296339.31,
      pkr: 149628185127113.97,
      pln: 2204178313639.1787,
      rub: 42053671312974.41,
      sar: 1968923639340.7654,
      sek: 5574470474705.742,
      sgd: 705863780495.8927,
      thb: 18014853895462.883,
      try: 10401042466247.857,
      twd: 16084599977408.418,
      uah: 19340012335663.28,
      usd: 525040003344.1629,
      vef: 52572255534.850945,
      vnd: 12327939278520940,
      xag: 22017951570.64008,
      xau: 265460225.69080865,
      xdr: 389335538879.81445,
      xlm: 5898948843689.886,
      xrp: 1117113800004.0676,
      yfi: 78514682.23918517,
      zar: 10212868129049.318,
      bits: 19380443490338.72,
      link: 80687422373.92957,
      sats: 1938044349033872,
    },
    total_volume: {
      aed: 14256597874.450903,
      ars: 898778326179.8566,
      aud: 5840928900.399667,
      bch: 33339067.566705935,
      bdt: 415515137205.25977,
      bhd: 1460975697.509895,
      bmd: 3882362454.219783,
      bnb: 12499717.1792248,
      brl: 19411812271.098843,
      btc: 143290.99449013598,
      cad: 5239830486.337729,
      chf: 3493237147.795792,
      clp: 3100454655939.9126,
      cny: 27206043134.1905,
      czk: 85392173944.31868,
      dkk: 26758018506.97357,
      dot: 717910860.1938026,
      eos: 4424319241.662215,
      eth: 2134320.52252947,
      eur: 3588964558.8294835,
      gbp: 3119241407.85588,
      hkd: 30345515532.79543,
      huf: 1349373306400.8984,
      idr: 57986965616226.68,
      ils: 14173340611.620148,
      inr: 321614129235.07556,
      jpy: 535630146090.57367,
      krw: 5144926136144.32,
      kwd: 1190301269.5641503,
      lkr: 1188760045434.7126,
      ltc: 42061955.201106325,
      mmk: 8130948659570.873,
      mxn: 69092657534.64503,
      myr: 17620101998.47644,
      ngn: 1794563467378.38,
      nok: 42527107146.339355,
      nzd: 6175716661.914396,
      php: 216049611509.05167,
      pkr: 1106412548244.9543,
      pln: 16298604054.496878,
      rub: 310962200075.5818,
      sar: 14559033909.634676,
      sek: 41219935119.8159,
      sgd: 5219448083.453073,
      thb: 133209263935.17941,
      try: 76909600218.09378,
      twd: 118936169902.66054,
      uah: 143008032298.2713,
      usd: 3882362454.219783,
      vef: 388740952.5410266,
      vnd: 91157870425080.5,
      xag: 162809820.1131721,
      xau: 1962922.4568535206,
      xdr: 2878907642.4898667,
      xlm: 43610828632.75137,
      xrp: 8266861490.213806,
      yfi: 580506.9978345768,
      zar: 75518161514.50145,
      bits: 143290994490.136,
      link: 596732667.9914253,
      sats: 14329099449013.6,
    },
  },
  community_data: {
    facebook_likes: null,
    twitter_followers: null,
    reddit_average_posts_48h: 0,
    reddit_average_comments_48h: 0,
    reddit_subscribers: null,
    reddit_accounts_active_48h: null,
  },
  developer_data: {
    forks: 34256,
    stars: 69602,
    subscribers: 3932,
    total_issues: 7444,
    closed_issues: 7098,
    pull_requests_merged: 10677,
    pull_request_contributors: 826,
    code_additions_deletions_4_weeks: {
      additions: 1206,
      deletions: -944,
    },
    commit_count_4_weeks: 189,
  },
  public_interest_stats: {
    alexa_rank: null,
    bing_matches: null,
  },
};
const mockAxiosHistory = (coinId, date) => {
  // https://api.coingecko.com/api/v3/coins/bitcoin/history?date=30-12-2022
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve(
        date === "21-05-2023"
          ? MOCK_HISTORY_DATA_AFTER
          : MOCK_HISTORY_DATA_BEFORE
      );
    }, 500);
  });
};
/**
 *
 * @param {number} coinId
 * @param {string} dateString
 * @param {string} currency
 * @example getPriceAtDate("bitcoin", "18-05-2023", "krw") => 20982847.247772843
 * @returns 해당 코인의 해당 날짜의 가격을 화폐단위로 리턴
 */
const getPriceAtDate = async (coinId, dateString, currency) => {
  const response = await mockAxiosHistory(coinId, dateString);
  const price = response.market_data.current_price[currency];
  return price.toFixed(2);
};

const userInputStore = (set, get) => ({
  // default: BitCoin
  selectedCoinInfo: {
    id: "bitcoin",
    name: "Bitcoin",
    imageUrl:
      "https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579",
  },
  // default: 5년 전 오늘 날짜
  selectedDate: (() => {
    const today = new Date();
    const fiveYearsAgo = new Date(today.toLocaleDateString());

    fiveYearsAgo.setFullYear(today.getFullYear() - 5);
    return fiveYearsAgo;
  })(),
  selectedMoney: 0,
  calculatedMoney: -1,
  selectedCurrency: "krw",
  calculateMoney: async () => {
    try {
      const {
        selectedDate,
        selectedMoney,
        selectedCoinInfo,
        selectedCurrency,
        saveRecord,
      } = get();
      // API 요청을 통해 선택한 시점의 가격과 현재 가격을 가져옴
      const todayDate = new Date();
      const querifiedSelectedDate = formatDateToString(selectedDate, true); // dd-MM-yyyy 형태로 포맷
      const querifiedTodayDate = formatDateToString(todayDate, true);
      const coinPriceResponses = await Promise.all([
        getPriceAtDate(
          selectedCoinInfo.id,
          querifiedSelectedDate,
          selectedCurrency
        ),
        getPriceAtDate(
          selectedCoinInfo.id,
          querifiedTodayDate,
          selectedCurrency
        ),
      ]);
      const [beforePrice, todayPrice] = coinPriceResponses;
      // calculatedMoney 를 계산: 오늘 가격 * (selectedMoney / 선택한 날짜의 가격)
      const calculatedMoney = (
        todayPrice *
        (selectedMoney / beforePrice)
      ).toFixed(2);
      set({ calculatedMoney });
      saveRecord(
        selectedDate,
        todayDate,
        selectedMoney,
        calculatedMoney,
        selectedCoinInfo.name,
        selectedCurrency
      );
    } catch (error) {
      throw new Error(error);
    }
  },
  saveRecord: (
    pastDate,
    futureDate,
    pastMoney,
    futureMoney,
    coinName,
    currency
  ) => {
    // records 가 null이면 빈 배열로 시작
    const storedRecords = JSON.parse(localStorage.getItem("records")) || [];
    // 새로운 레코드 생성
    const newRecord = {
      id: storedRecords.length + 1,
      coinName,
      past: {
        date: formatDateToString(pastDate),
        money: formatMoneyToString(Math.round(pastMoney), currency),
      },
      future: {
        date: formatDateToString(futureDate),
        money: formatMoneyToString(Math.round(futureMoney), currency),
      },
      currency,
    };

    // 새로운 레코드를 배열에 추가
    storedRecords.push(newRecord);

    // 업데이트된 배열을 다시 로컬 스토리지에 저장
    localStorage.setItem("records", JSON.stringify(storedRecords));
  },
  resetAll: () => {
    // store의 초기값으로 리셋
    set({
      selectedCoinInfo: {
        id: "bitcoin",
        name: "Bitcoin",
        imageUrl:
          "https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579",
      },
      selectedDate: (() => {
        const today = new Date();
        const fiveYearsAgo = new Date(today.toLocaleDateString());
        fiveYearsAgo.setFullYear(today.getFullYear() - 5);
        return fiveYearsAgo;
      })(),
      selectedMoney: 0,
      calculatedMoney: -1,
      selectedCurrency: "krw",
    });
  },
});

const useUserInputStore = create(userInputStore);
export default useUserInputStore;
